<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlexPool Controller</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="FlexPool">
  <meta name="theme-color" content="#0f172a">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
      padding: 16px;
    }
    h1 {
      text-align: center;
      font-size: 1.5rem;
      padding: 16px 0 4px;
      color: #38bdf8;
      letter-spacing: 1px;
    }
    h1 span { color: #94a3b8; font-weight: 300; font-size: 0.9rem; display: block; }

    /* Connection banner */
    .conn-bar {
      display: flex; justify-content: center; align-items: center; gap: 8px;
      padding: 8px; margin-bottom: 12px; border-radius: 10px;
      font-size: 0.8rem; text-align: center;
    }
    .conn-bar.connected { background: #052e16; color: #4ade80; }
    .conn-bar.connecting { background: #422006; color: #fbbf24; }
    .conn-bar.disconnected { background: #450a0a; color: #f87171; }
    .conn-dot { width: 8px; height: 8px; border-radius: 50%; }
    .conn-bar.connected .conn-dot { background: #22c55e; box-shadow: 0 0 6px #22c55e; }
    .conn-bar.connecting .conn-dot { background: #f59e0b; box-shadow: 0 0 6px #f59e0b; }
    .conn-bar.disconnected .conn-dot { background: #ef4444; box-shadow: 0 0 6px #ef4444; }

    /* ======== BLE SETUP SCREEN ======== */
    .setup-screen {
      max-width: 440px; margin: 0 auto;
    }
    .setup-card {
      background: #1e293b; border-radius: 16px; padding: 24px;
      margin-bottom: 16px; border: 1px solid #334155;
    }
    .setup-card h2 {
      font-size: 1.15rem; color: #e2e8f0; margin-bottom: 12px;
    }
    .setup-card p {
      font-size: 0.85rem; color: #94a3b8; line-height: 1.5; margin-bottom: 16px;
    }
    .setup-card .warn {
      font-size: 0.75rem; color: #fbbf24; background: #422006;
      border-radius: 8px; padding: 10px; margin-bottom: 16px; line-height: 1.4;
    }
    .btn-ble {
      width: 100%; border: none; border-radius: 14px; padding: 18px;
      font-size: 1.1rem; font-weight: 700; cursor: pointer;
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      color: white; transition: all 0.15s; letter-spacing: 0.5px;
    }
    .btn-ble:active { transform: scale(0.97); }
    .btn-ble:disabled { opacity: 0.4; cursor: not-allowed; }
    .ble-status {
      text-align: center; font-size: 0.85rem; color: #94a3b8;
      margin-top: 12px; min-height: 1.2em;
    }
    .ble-status.ok { color: #4ade80; }
    .ble-status.err { color: #f87171; }

    /* WiFi form inside BLE setup */
    .wifi-form { display: none; }
    .wifi-form.show { display: block; }
    .wifi-form label {
      font-size: 0.85rem; color: #94a3b8; display: block; margin-bottom: 4px; margin-top: 14px;
    }
    .wifi-form input[type="text"],
    .wifi-form input[type="password"] {
      width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #475569;
      background: #0f172a; color: #e2e8f0; font-size: 1rem;
    }
    .wifi-form .btn-send-wifi {
      width: 100%; margin-top: 16px; border: none; border-radius: 12px; padding: 16px;
      font-size: 1rem; font-weight: 600; cursor: pointer;
      background: linear-gradient(135deg, #16a34a, #059669); color: white;
    }
    .wifi-form .btn-send-wifi:active { transform: scale(0.97); }
    .wifi-form .btn-send-wifi:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Success screen */
    .setup-success { display: none; text-align: center; }
    .setup-success.show { display: block; }
    .setup-success .checkmark { font-size: 3rem; margin-bottom: 12px; }
    .setup-success .device-id-display {
      font-size: 2rem; font-weight: 700; color: #38bdf8;
      font-family: 'Courier New', monospace; letter-spacing: 4px;
      margin: 12px 0;
    }
    .setup-success .btn-go {
      width: 100%; margin-top: 16px; border: none; border-radius: 14px; padding: 18px;
      font-size: 1.1rem; font-weight: 700; cursor: pointer;
      background: linear-gradient(135deg, #16a34a, #059669); color: white;
    }

    /* Manual fallback link */
    .manual-link {
      text-align: center; margin-top: 12px;
    }
    .manual-link a {
      color: #64748b; font-size: 0.75rem; cursor: pointer; text-decoration: underline;
    }

    /* Manual device ID section (fallback) */
    .device-section {
      background: #1e293b; border-radius: 12px; padding: 14px;
      margin-bottom: 12px; border: 1px solid #334155;
    }
    .device-section.hide { display: none; }
    .device-section label { font-size: 0.85rem; color: #94a3b8; display: block; margin-bottom: 6px; }
    .device-section .hint { font-size: 0.7rem; color: #64748b; margin-top: 6px; }
    .device-row { display: flex; gap: 8px; }
    .device-row input {
      flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #475569;
      background: #0f172a; color: #e2e8f0; font-size: 1.1rem;
      font-family: 'Courier New', monospace; letter-spacing: 3px; text-transform: uppercase;
    }
    .device-row button {
      padding: 12px 20px; border-radius: 8px; border: none;
      background: #2563eb; color: white; font-weight: 600; cursor: pointer; font-size: 1rem;
    }
    .device-row button:active { background: #1d4ed8; }
    .btn-disconnect {
      margin-top: 8px; padding: 6px 12px; border-radius: 6px; border: 1px solid #475569;
      background: transparent; color: #94a3b8; font-size: 0.75rem; cursor: pointer;
    }
    .btn-back-setup {
      margin-top: 6px; padding: 6px 12px; border-radius: 6px; border: 1px solid #475569;
      background: transparent; color: #94a3b8; font-size: 0.75rem; cursor: pointer;
    }

    /* Status card */
    .status-card {
      background: #1e293b; border-radius: 16px; padding: 20px;
      margin-bottom: 16px; border: 1px solid #334155;
    }
    .status-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 16px;
    }
    .status-dot {
      width: 12px; height: 12px; border-radius: 50%;
      display: inline-block; margin-right: 8px;
    }
    .dot-running { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
    .dot-stopped { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
    .dot-unknown { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
    .status-label { font-size: 1.1rem; font-weight: 600; }
    .status-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
    }
    .stat-item {
      background: #0f172a; border-radius: 10px; padding: 12px; text-align: center;
    }
    .stat-value { font-size: 1.6rem; font-weight: 700; color: #38bdf8; }
    .stat-label {
      font-size: 0.75rem; color: #94a3b8;
      text-transform: uppercase; letter-spacing: 1px; margin-top: 2px;
    }

    .section-title {
      font-size: 0.8rem; color: #64748b;
      text-transform: uppercase; letter-spacing: 2px; margin: 20px 0 10px;
    }

    /* ======== SPEED BUTTONS ======== */
    .speed-section {
      background: #1e293b; border-radius: 16px; padding: 20px;
      margin-bottom: 16px; border: 1px solid #334155;
    }
    .speed-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
    }
    .speed-btn {
      border: none; border-radius: 14px; padding: 20px 8px;
      cursor: pointer; transition: all 0.15s; color: white;
      text-align: center; position: relative; overflow: hidden;
    }
    .speed-btn:active { transform: scale(0.96); }
    .speed-btn.active { box-shadow: 0 0 0 3px #38bdf8, 0 0 20px rgba(56,189,248,0.3); }
    .speed-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .speed-name { font-size: 1.2rem; font-weight: 700; display: block; }
    .speed-rpm { font-size: 0.85rem; opacity: 0.85; margin-top: 4px; display: block; }
    .speed-1 { background: linear-gradient(135deg, #0891b2, #06b6d4); }
    .speed-2 { background: linear-gradient(135deg, #2563eb, #3b82f6); }
    .speed-3 { background: linear-gradient(135deg, #7c3aed, #8b5cf6); }
    .speed-4 { background: linear-gradient(135deg, #c2410c, #ea580c); }

    /* STOP button */
    .stop-section { margin-bottom: 16px; }
    .btn-bigstop {
      width: 100%; border: none; border-radius: 14px; padding: 18px;
      font-size: 1.15rem; font-weight: 700; cursor: pointer;
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: white; transition: all 0.15s; letter-spacing: 1px;
    }
    .btn-bigstop:active { transform: scale(0.97); }
    .btn-bigstop:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Custom RPM */
    .rpm-section {
      background: #1e293b; border-radius: 16px; padding: 20px;
      margin-bottom: 16px; border: 1px solid #334155;
    }
    .rpm-display {
      text-align: center; font-size: 2.5rem; font-weight: 700;
      color: #38bdf8; margin: 8px 0;
    }
    .rpm-display span { font-size: 1rem; color: #94a3b8; }
    input[type="range"] {
      width: 100%; height: 8px; -webkit-appearance: none;
      background: #334155; border-radius: 4px; outline: none; margin: 12px 0;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 28px; height: 28px;
      border-radius: 50%; background: #38bdf8; cursor: pointer;
    }
    .rpm-presets {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px;
    }
    .rpm-preset {
      border: 1px solid #475569; background: transparent; color: #e2e8f0;
      border-radius: 8px; padding: 8px 4px; font-size: 0.8rem; cursor: pointer;
    }
    .rpm-preset:active { background: #334155; }
    .btn-setcustom {
      width: 100%; margin-top: 12px; border: none; border-radius: 12px;
      padding: 14px; font-size: 1rem; font-weight: 600; cursor: pointer;
      background: linear-gradient(135deg, #16a34a, #0891b2); color: white;
    }
    .btn-setcustom:active { transform: scale(0.97); }
    .btn-setcustom:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Buttons */
    .btn-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px; }
    .btn {
      border: none; border-radius: 12px; padding: 14px 8px; font-size: 0.95rem;
      font-weight: 600; cursor: pointer; transition: all 0.15s; color: white; text-align: center;
    }
    .btn:active { transform: scale(0.96); }
    .btn-start  { background: #16a34a; }
    .btn-stop   { background: #dc2626; }
    .btn-remote { background: #2563eb; }
    .btn-local  { background: #7c3aed; }
    .btn-query  { background: #0891b2; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Collapsible advanced */
    .advanced-toggle {
      width: 100%; background: #1e293b; border: 1px solid #334155;
      border-radius: 12px; padding: 12px; color: #64748b;
      font-size: 0.85rem; cursor: pointer; text-align: center;
      margin-bottom: 12px;
    }
    .advanced-toggle:active { background: #334155; }
    .advanced-panel { display: none; }
    .advanced-panel.show { display: block; }

    /* Settings */
    .settings-section {
      background: #1e293b; border-radius: 16px; padding: 20px;
      margin-bottom: 16px; border: 1px solid #334155;
    }
    .setting-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0; border-bottom: 1px solid #334155;
    }
    .setting-row:last-child { border-bottom: none; }
    .setting-label { font-size: 0.9rem; color: #94a3b8; }
    .setting-input {
      width: 90px; padding: 8px; border-radius: 8px; border: 1px solid #475569;
      background: #0f172a; color: #38bdf8; font-size: 1rem;
      text-align: center; font-weight: 600;
    }
    .btn-save-settings {
      width: 100%; margin-top: 12px; border: none; border-radius: 12px;
      padding: 12px; font-size: 0.9rem; font-weight: 600; cursor: pointer;
      background: #475569; color: white;
    }

    /* Log */
    .log-section {
      background: #1e293b; border-radius: 16px; padding: 16px;
      margin-top: 16px; border: 1px solid #334155;
    }
    .log-box {
      background: #0f172a; border-radius: 8px; padding: 10px;
      max-height: 200px; overflow-y: auto;
      font-family: 'Courier New', monospace; font-size: 0.75rem;
      color: #94a3b8; line-height: 1.5;
    }
    .log-entry { border-bottom: 1px solid #1e293b; padding: 2px 0; }
    .log-ok { color: #22c55e; }
    .log-err { color: #ef4444; }

    .toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: #334155; color: #e2e8f0; padding: 12px 24px;
      border-radius: 12px; font-size: 0.9rem; opacity: 0;
      transition: opacity 0.3s; pointer-events: none; z-index: 100;
    }
    .toast.show { opacity: 1; }
    .info-bar {
      text-align: center; color: #475569; font-size: 0.7rem; margin-top: 12px; line-height: 1.6;
    }
  </style>
</head>
<body>
  <h1>FlexPool <span>Pentair Pump Controller</span></h1>

  <!-- MQTT CONNECTION STATUS -->
  <div class="conn-bar disconnected" id="connBar">
    <div class="conn-dot"></div>
    <span id="connLabel">Not connected</span>
  </div>

  <!-- =============================================
       SCREEN 1: BLE SETUP (first-time / no Device ID)
       ============================================= -->
  <div class="setup-screen" id="setupScreen">
    <div class="setup-card">
      <h2>Setup Your FlexPool Device</h2>
      <p>Connect to your ESP32 via Bluetooth to configure WiFi. 
         After setup, the Device ID is saved automatically and you won't need to do this again.</p>
      <div class="warn">
        Web Bluetooth requires <strong>Chrome</strong> on Windows, Mac, or Android.<br>
        iPhones (Safari) do NOT support Web Bluetooth.
      </div>

      <!-- Step 1: Connect via BLE -->
      <button class="btn-ble" id="btnBLE" onclick="startBLESetup()">
        Connect via Bluetooth
      </button>
      <div class="ble-status" id="bleStatus"></div>

      <!-- Step 2: WiFi form (shown after BLE connects) -->
      <div class="wifi-form" id="wifiForm">
        <label for="wifiSSID">WiFi Network Name (SSID)</label>
        <input type="text" id="wifiSSID" placeholder="Your WiFi name" autocomplete="off">
        <label for="wifiPass">WiFi Password</label>
        <input type="password" id="wifiPass" placeholder="WiFi password" autocomplete="off">
        <button class="btn-send-wifi" id="btnSendWifi" onclick="sendWiFiCredentials()">
          Send WiFi Credentials
        </button>
      </div>

      <!-- Step 3: Success (shown after ESP32 connects to WiFi) -->
      <div class="setup-success" id="setupSuccess">
        <div class="checkmark">&#10004;</div>
        <p style="color:#4ade80; font-weight:600;">WiFi Connected! Device ID received.</p>
        <div class="device-id-display" id="bleDeviceId"></div>
        <button class="btn-go" onclick="finishSetup()">Go to Control Panel</button>
      </div>
    </div>

    <!-- Manual fallback -->
    <div class="manual-link">
      <a onclick="showManualEntry()">Already have a Device ID? Enter it manually</a>
    </div>

    <!-- Manual Device ID entry (hidden by default) -->
    <div class="device-section hide" id="manualSection">
      <label>Enter Device ID manually:</label>
      <div class="device-row">
        <input type="text" id="deviceInput" placeholder="e.g. A1B2C3" maxlength="6">
        <button onclick="manualConnect()">Connect</button>
      </div>
      <div class="hint">Find your Device ID in the Arduino Serial Monitor after WiFi setup completes</div>
      <button class="btn-back-setup" onclick="hideManualEntry()">Back to Bluetooth setup</button>
    </div>
  </div>

  <!-- =============================================
       SCREEN 2: CONTROL PANEL (after Device ID is set)
       ============================================= -->
  <div id="controlPanel" style="display:none;">

    <!-- CONNECTED DEVICE BAR -->
    <div class="device-section" id="connectedSection">
      <label>Connected to device: <strong id="connDeviceId"></strong></label>
      <button class="btn-disconnect" onclick="disconnect()">Disconnect / Change Device</button>
    </div>

    <!-- STATUS CARD -->
    <div class="status-card">
      <div class="status-header">
        <div>
          <span class="status-dot dot-unknown" id="statusDot"></span>
          <span class="status-label" id="statusLabel">Waiting for data...</span>
        </div>
        <button class="btn btn-query" style="padding:8px 16px; font-size:0.8rem;" onclick="sendCmd('query')" id="btnRefresh" disabled>Refresh</button>
      </div>
      <div class="status-grid">
        <div class="stat-item">
          <div class="stat-value" id="rpmVal">--</div>
          <div class="stat-label">RPM</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="wattsVal">--</div>
          <div class="stat-label">Watts</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="gpmVal">--</div>
          <div class="stat-label">GPM</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="modeVal">--</div>
          <div class="stat-label">Mode</div>
        </div>
      </div>
    </div>

    <!-- SPEED BUTTONS -->
    <div class="speed-section">
      <div class="section-title" style="margin-top:0">Select Speed</div>
      <div class="speed-grid">
        <button class="speed-btn speed-1" id="speedBtn1" onclick="setSpeed(1)" disabled>
          <span class="speed-name">Speed 1</span>
          <span class="speed-rpm" id="speedLabel1">750 RPM</span>
        </button>
        <button class="speed-btn speed-2" id="speedBtn2" onclick="setSpeed(2)" disabled>
          <span class="speed-name">Speed 2</span>
          <span class="speed-rpm" id="speedLabel2">1500 RPM</span>
        </button>
        <button class="speed-btn speed-3" id="speedBtn3" onclick="setSpeed(3)" disabled>
          <span class="speed-name">Speed 3</span>
          <span class="speed-rpm" id="speedLabel3">2350 RPM</span>
        </button>
        <button class="speed-btn speed-4" id="speedBtn4" onclick="setSpeed(4)" disabled>
          <span class="speed-name">Speed 4</span>
          <span class="speed-rpm" id="speedLabel4">3110 RPM</span>
        </button>
      </div>
    </div>

    <!-- STOP BUTTON -->
    <div class="stop-section">
      <button class="btn-bigstop" id="btnStop" onclick="sendCmd('fullstop')" disabled>STOP PUMP</button>
    </div>

    <!-- CUSTOM RPM -->
    <div class="rpm-section">
      <div class="section-title" style="margin-top:0">Custom RPM</div>
      <div class="rpm-display"><span id="rpmTarget">1000</span> <span>RPM</span></div>
      <input type="range" id="rpmSlider" min="450" max="3450" step="50" value="1000"
             oninput="document.getElementById('rpmTarget').textContent=this.value">
      <div class="rpm-presets">
        <button class="rpm-preset" onclick="setSlider(600)">600</button>
        <button class="rpm-preset" onclick="setSlider(1100)">1100</button>
        <button class="rpm-preset" onclick="setSlider(2000)">2000</button>
        <button class="rpm-preset" onclick="setSlider(3000)">3000</button>
      </div>
      <button class="btn-setcustom" id="btnCustom" onclick="fullStartCustom()" disabled>Start at Custom RPM</button>
    </div>

    <!-- ADVANCED COMMANDS -->
    <button class="advanced-toggle" onclick="toggleAdvanced()">
      &#9660; Advanced / Manual Commands
    </button>
    <div class="advanced-panel" id="advancedPanel">
      <div class="settings-section">
        <div class="section-title" style="margin-top:0">Speed Settings (RPM)</div>
        <div class="setting-row">
          <span class="setting-label">Speed 1</span>
          <input type="number" class="setting-input" id="cfg1" min="450" max="3450" step="50" value="750">
        </div>
        <div class="setting-row">
          <span class="setting-label">Speed 2</span>
          <input type="number" class="setting-input" id="cfg2" min="450" max="3450" step="50" value="1500">
        </div>
        <div class="setting-row">
          <span class="setting-label">Speed 3</span>
          <input type="number" class="setting-input" id="cfg3" min="450" max="3450" step="50" value="2350">
        </div>
        <div class="setting-row">
          <span class="setting-label">Speed 4</span>
          <input type="number" class="setting-input" id="cfg4" min="450" max="3450" step="50" value="3110">
        </div>
        <button class="btn-save-settings" onclick="saveSettings()">Save Speed Settings</button>
      </div>
      <div class="section-title">Manual Commands</div>
      <div class="btn-row">
        <button class="btn btn-start"  onclick="sendCmd('start')">Start Motor</button>
        <button class="btn btn-stop"   onclick="sendCmd('stop')">Stop Motor</button>
      </div>
      <div class="btn-row">
        <button class="btn btn-remote" onclick="sendCmd('remote')">Remote Control</button>
        <button class="btn btn-local"  onclick="sendCmd('local')">Local Control</button>
      </div>
      <div class="btn-row">
        <button class="btn btn-query" onclick="sendCmd('query')">Query Status</button>
        <button class="btn" style="background:#475569" onclick="setRPMOnly()">Set RPM Only</button>
      </div>
    </div>

    <!-- LOG -->
    <div class="log-section">
      <div class="section-title" style="margin-top:0">Activity Log</div>
      <div class="log-box" id="logBox"></div>
    </div>

    <div class="info-bar" id="infoBar"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // =============================================
    // BLE UUIDs (must match BLESetup.h on ESP32)
    // =============================================
    const BLE_SERVICE_UUID    = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
    const BLE_CHAR_WIFI_UUID  = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
    const BLE_CHAR_STATUS_UUID = 'd1a7e0c2-4f3b-4b1e-9c5d-8a6f2b3e4d5c';

    let bleDevice = null;
    let bleCharWifi = null;
    let bleCharStatus = null;

    // =============================================
    // SPEED PRESETS
    // =============================================
    const DEFAULT_SPEEDS = [750, 1500, 2350, 3110];
    let speeds = [...DEFAULT_SPEEDS];
    let activeSpeed = 0;

    function loadSettings() {
      const saved = localStorage.getItem('flexpool_speeds');
      if (saved) {
        try {
          const arr = JSON.parse(saved);
          if (arr.length === 4) speeds = arr;
        } catch(e) {}
      }
      for (let i = 1; i <= 4; i++) {
        document.getElementById('speedLabel' + i).textContent = speeds[i-1] + ' RPM';
        document.getElementById('cfg' + i).value = speeds[i-1];
      }
    }

    function saveSettings() {
      for (let i = 1; i <= 4; i++) {
        const val = parseInt(document.getElementById('cfg' + i).value);
        if (val >= 450 && val <= 3450) speeds[i-1] = val;
      }
      localStorage.setItem('flexpool_speeds', JSON.stringify(speeds));
      loadSettings();
      showToast('Speed settings saved!');
      addLog('Speed settings: ' + speeds.join(', ') + ' RPM', true);
    }

    // =============================================
    // MQTT
    // =============================================
    const MQTT_BROKER = 'wss://broker.hivemq.com:8884/mqtt';
    let DEVICE_ID = '';
    let mqttClient = null;
    let topicCmd = '';
    let topicStatus = '';

    // =============================================
    // INIT — decide which screen to show
    // =============================================
    window.addEventListener('load', () => {
      const saved = localStorage.getItem('flexpool_device_id');
      if (saved) {
        // Already set up — go straight to control panel
        DEVICE_ID = saved;
        showControlPanel();
        loadSettings();
        addLog('Using saved Device ID: ' + DEVICE_ID, null);
        connectMQTT(DEVICE_ID);
      } else {
        // First time — show BLE setup screen
        showSetupScreen();
      }
    });

    // =============================================
    // SCREEN SWITCHING
    // =============================================
    function showSetupScreen() {
      document.getElementById('setupScreen').style.display = 'block';
      document.getElementById('controlPanel').style.display = 'none';
      setConnStatus('disconnected', 'Not connected — Setup required');
    }

    function showControlPanel() {
      document.getElementById('setupScreen').style.display = 'none';
      document.getElementById('controlPanel').style.display = 'block';
      document.getElementById('connDeviceId').textContent = DEVICE_ID;
      loadSettings();
    }

    // =============================================
    // BLE SETUP FLOW
    // =============================================
    async function startBLESetup() {
      const statusEl = document.getElementById('bleStatus');
      const btnBLE = document.getElementById('btnBLE');

      // Check if Web Bluetooth is supported
      if (!navigator.bluetooth) {
        statusEl.className = 'ble-status err';
        statusEl.textContent = 'Web Bluetooth not supported. Use Chrome on Windows, Mac, or Android.';
        return;
      }

      try {
        btnBLE.disabled = true;
        statusEl.className = 'ble-status';
        statusEl.textContent = 'Searching for FlexPool device...';

        // Request BLE device — browser shows a picker dialog
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'FlexPool' }],
          optionalServices: [BLE_SERVICE_UUID]
        });

        statusEl.textContent = 'Connecting to ' + bleDevice.name + '...';

        // Connect to GATT server
        const server = await bleDevice.gatt.connect();
        const service = await server.getPrimaryService(BLE_SERVICE_UUID);

        // Get characteristics
        bleCharWifi = await service.getCharacteristic(BLE_CHAR_WIFI_UUID);
        bleCharStatus = await service.getCharacteristic(BLE_CHAR_STATUS_UUID);

        // Listen for status notifications from ESP32
        await bleCharStatus.startNotifications();
        bleCharStatus.addEventListener('characteristicvaluechanged', onBLEStatusNotification);

        // Handle disconnection
        bleDevice.addEventListener('gattserverdisconnected', () => {
          statusEl.className = 'ble-status err';
          statusEl.textContent = 'Bluetooth disconnected.';
          btnBLE.disabled = false;
        });

        // Success — show WiFi form
        statusEl.className = 'ble-status ok';
        statusEl.textContent = 'Connected to FlexPool via Bluetooth!';
        document.getElementById('wifiForm').classList.add('show');
        btnBLE.textContent = 'Connected';

      } catch (err) {
        btnBLE.disabled = false;
        statusEl.className = 'ble-status err';
        if (err.name === 'NotFoundError') {
          statusEl.textContent = 'No FlexPool device found. Make sure ESP32 is in BLE setup mode.';
        } else if (err.name === 'SecurityError') {
          statusEl.textContent = 'Bluetooth permission denied.';
        } else {
          statusEl.textContent = 'Error: ' + err.message;
        }
      }
    }

    async function sendWiFiCredentials() {
      const ssid = document.getElementById('wifiSSID').value.trim();
      const pass = document.getElementById('wifiPass').value;
      const statusEl = document.getElementById('bleStatus');
      const btnSend = document.getElementById('btnSendWifi');

      if (!ssid) {
        showToast('Enter a WiFi network name');
        return;
      }

      if (!bleCharWifi) {
        statusEl.className = 'ble-status err';
        statusEl.textContent = 'Not connected via Bluetooth. Click Connect first.';
        return;
      }

      try {
        btnSend.disabled = true;
        statusEl.className = 'ble-status';
        statusEl.textContent = 'Sending WiFi credentials to ESP32...';

        // Send credentials as JSON (matches BLESetup.h format)
        const json = JSON.stringify({ ssid: ssid, pass: pass });
        const encoder = new TextEncoder();
        await bleCharWifi.writeValue(encoder.encode(json));

        statusEl.textContent = 'WiFi credentials sent! ESP32 is connecting to WiFi...';

      } catch (err) {
        btnSend.disabled = false;
        statusEl.className = 'ble-status err';
        statusEl.textContent = 'Failed to send: ' + err.message;
      }
    }

    function onBLEStatusNotification(event) {
      const decoder = new TextDecoder();
      const value = decoder.decode(event.target.value);
      const statusEl = document.getElementById('bleStatus');

      try {
        const data = JSON.parse(value);

        if (data.ok === true && data.id) {
          // WiFi connected! ESP32 sent back the Device ID
          statusEl.className = 'ble-status ok';
          statusEl.textContent = 'WiFi connected! Device ID: ' + data.id;

          // Save Device ID
          DEVICE_ID = data.id;
          localStorage.setItem('flexpool_device_id', data.id);

          // Show success screen
          document.getElementById('wifiForm').classList.remove('show');
          document.getElementById('setupSuccess').classList.add('show');
          document.getElementById('bleDeviceId').textContent = data.id;
          document.getElementById('btnBLE').style.display = 'none';

        } else if (data.ok === false) {
          // WiFi connection failed
          statusEl.className = 'ble-status err';
          statusEl.textContent = 'WiFi failed: ' + (data.error || 'Unknown error');
          document.getElementById('btnSendWifi').disabled = false;

        } else if (data.networks) {
          // WiFi scan results (future feature)
          statusEl.textContent = 'Found ' + data.networks.length + ' networks.';
        }
      } catch (e) {
        statusEl.textContent = 'ESP32: ' + value;
      }
    }

    function finishSetup() {
      // Disconnect BLE (no longer needed)
      if (bleDevice && bleDevice.gatt.connected) {
        bleDevice.gatt.disconnect();
      }
      // Switch to control panel
      showControlPanel();
      connectMQTT(DEVICE_ID);
      addLog('Setup complete! Device ID: ' + DEVICE_ID, true);
    }

    // =============================================
    // MANUAL DEVICE ID (fallback)
    // =============================================
    function showManualEntry() {
      document.getElementById('manualSection').classList.remove('hide');
    }

    function hideManualEntry() {
      document.getElementById('manualSection').classList.add('hide');
    }

    function manualConnect() {
      const id = document.getElementById('deviceInput').value.trim().toUpperCase();
      if (id.length < 4) {
        showToast('Enter a valid Device ID (from Serial Monitor)');
        return;
      }
      DEVICE_ID = id;
      localStorage.setItem('flexpool_device_id', id);
      showControlPanel();
      connectMQTT(id);
    }

    function disconnect() {
      if (mqttClient) {
        mqttClient.end();
        mqttClient = null;
      }
      DEVICE_ID = '';
      localStorage.removeItem('flexpool_device_id');
      showSetupScreen();
      setConnStatus('disconnected', 'Not connected — Setup required');
      setButtonsEnabled(false);
      addLog('Disconnected', false);
    }

    // =============================================
    // MQTT CONNECTION
    // =============================================
    function connectMQTT(deviceId) {
      topicCmd    = 'flexpool/' + deviceId + '/cmd';
      topicStatus = 'flexpool/' + deviceId + '/status';
      const topicLWT = 'flexpool/' + deviceId + '/lwt';

      setConnStatus('connecting', 'Connecting to cloud...');
      addLog('Connecting to MQTT broker...', null);

      const clientId = 'flexpool-web-' + Math.random().toString(16).substr(2, 6);

      mqttClient = mqtt.connect(MQTT_BROKER, {
        clientId: clientId,
        clean: true,
        connectTimeout: 10000,
        reconnectPeriod: 3000,
      });

      mqttClient.on('connect', () => {
        setConnStatus('connected', 'Connected — Device: ' + deviceId);
        addLog('Connected to MQTT broker', true);
        mqttClient.subscribe(topicStatus);
        mqttClient.subscribe(topicLWT);
        addLog('Listening for pump status...', null);
        setButtonsEnabled(true);
      });

      mqttClient.on('message', (topic, message) => {
        try {
          const data = JSON.parse(message.toString());
          if (topic === topicStatus) {
            updateStatus(data);
          } else if (topic === topicLWT) {
            if (data.online === false) {
              setConnStatus('disconnected', 'ESP32 is offline');
              addLog('ESP32 went offline', false);
            }
          }
        } catch (e) {
          addLog('Bad message: ' + message.toString(), false);
        }
      });

      mqttClient.on('error', (err) => {
        setConnStatus('disconnected', 'Connection error');
        addLog('MQTT error: ' + err.message, false);
      });

      mqttClient.on('close', () => {
        setConnStatus('connecting', 'Reconnecting...');
        setButtonsEnabled(false);
      });

      mqttClient.on('reconnect', () => {
        setConnStatus('connecting', 'Reconnecting...');
      });
    }

    // =============================================
    // SEND COMMANDS
    // =============================================
    function sendCmd(cmd, extra) {
      if (!mqttClient || !mqttClient.connected) {
        showToast('Not connected');
        addLog('Cannot send — not connected', false);
        return;
      }
      let payload = { cmd: cmd };
      if (extra) Object.assign(payload, extra);
      const msg = JSON.stringify(payload);
      mqttClient.publish(topicCmd, msg);
      addLog('Sent: ' + msg, true);
      showToast('Command sent: ' + cmd);
    }

    function setSpeed(num) {
      const rpm = speeds[num - 1];
      activeSpeed = num;
      highlightSpeed(num);
      sendCmd('fullstart', { rpm: rpm });
      addLog('Speed ' + num + ' → ' + rpm + ' RPM', true);
    }

    function highlightSpeed(num) {
      for (let i = 1; i <= 4; i++) {
        document.getElementById('speedBtn' + i).classList.remove('active');
      }
      if (num > 0) {
        document.getElementById('speedBtn' + num).classList.add('active');
      }
    }

    function fullStartCustom() {
      const rpm = parseInt(document.getElementById('rpmSlider').value);
      activeSpeed = 0;
      highlightSpeed(0);
      sendCmd('fullstart', { rpm: rpm });
    }

    function setRPMOnly() {
      const rpm = parseInt(document.getElementById('rpmSlider').value);
      sendCmd('rpm', { value: rpm });
    }

    // =============================================
    // UPDATE STATUS
    // =============================================
    function updateStatus(s) {
      const dot = document.getElementById('statusDot');
      const label = document.getElementById('statusLabel');
      if (s.running) {
        dot.className = 'status-dot dot-running';
        label.textContent = 'Running';
      } else {
        dot.className = 'status-dot dot-stopped';
        label.textContent = 'Stopped';
        activeSpeed = 0;
        highlightSpeed(0);
      }
      document.getElementById('rpmVal').textContent = s.rpm >= 0 ? s.rpm : '--';
      document.getElementById('wattsVal').textContent = s.watts >= 0 ? s.watts : '--';
      document.getElementById('gpmVal').textContent = s.gpm >= 0 ? s.gpm : '--';
      const modes = ['Filter','Manual','Speed 1','Speed 2','Speed 3','Speed 4'];
      document.getElementById('modeVal').textContent = modes[s.mode] || 'Mode ' + s.mode;

      // Auto-detect active speed from RPM
      if (s.running && s.rpm > 0) {
        let matched = 0;
        for (let i = 0; i < 4; i++) {
          if (Math.abs(s.rpm - speeds[i]) < 30) { matched = i + 1; break; }
        }
        if (matched > 0) { activeSpeed = matched; highlightSpeed(matched); }
      }

      const info = document.getElementById('infoBar');
      info.textContent = 'Device: ' + (s.deviceId || DEVICE_ID) +
        ' | RSSI: ' + (s.rssi || '?') + ' dBm' +
        ' | Uptime: ' + formatUptime(s.uptime || 0);
    }

    function formatUptime(sec) {
      if (sec < 60) return sec + 's';
      if (sec < 3600) return Math.floor(sec/60) + 'm';
      return Math.floor(sec/3600) + 'h ' + Math.floor((sec%3600)/60) + 'm';
    }

    // =============================================
    // UI HELPERS
    // =============================================
    function setButtonsEnabled(enabled) {
      const ids = ['speedBtn1','speedBtn2','speedBtn3','speedBtn4',
                   'btnStop','btnCustom','btnRefresh'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = !enabled;
      });
    }

    function setSlider(v) {
      document.getElementById('rpmSlider').value = v;
      document.getElementById('rpmTarget').textContent = v;
    }

    function toggleAdvanced() {
      const panel = document.getElementById('advancedPanel');
      const btn = panel.previousElementSibling;
      panel.classList.toggle('show');
      btn.innerHTML = panel.classList.contains('show')
        ? '&#9650; Advanced / Manual Commands'
        : '&#9660; Advanced / Manual Commands';
    }

    function setConnStatus(state, text) {
      const bar = document.getElementById('connBar');
      bar.className = 'conn-bar ' + state;
      document.getElementById('connLabel').textContent = text;
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
    }

    function addLog(msg, ok) {
      const box = document.getElementById('logBox');
      if (!box) return;
      const cls = ok === true ? 'log-ok' : (ok === false ? 'log-err' : '');
      const time = new Date().toLocaleTimeString();
      box.innerHTML = '<div class="log-entry ' + cls + '">[' + time + '] ' + msg + '</div>' + box.innerHTML;
      if (box.children.length > 50) box.removeChild(box.lastChild);
    }
  </script>
</body>
</html>
